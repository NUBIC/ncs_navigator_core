- initial_instrument_for_contact ||= nil

%p.hide
  = @contact_link.event
  %br
  = @contact_link.event.psc_segment_name

%h3 
  = "Instruments for #{@contact_link.event.psc_segment_name}"

- if initial_instrument_for_contact
  .instructional_note
    Choose the Instrument from the list below to administer for this contact.
    %br
    (If there is a Consent link in the list, you should obtain consent before proceeding.)

- no_consent = true
- if activities = psc.activities_for_segment(@person.participant, @contact_link.event.psc_segment_name)
  - activities.each do |activity|
    - instrument = InstrumentEventMap.instrument_for_activity(activity)
    - if instrument && survey = Survey.most_recent_for_title(instrument)
      - if @contact_link.contact.instruments.collect {|i| i.survey.title}.include?(survey.title)
        %span.known_instrument
          = "#{activity} - #{instrument}"
      - else
        = link_to "#{activity} - #{instrument}", start_instrument_person_path(@person, :survey_access_code => survey.access_code, :contact_link_id => @contact_link.id, :initial_instrument_for_contact => initial_instrument_for_contact), :class => "edit_link icon_link"
    - elsif activity.include?("Consent")
      - no_consent = false
      = determine_participant_consent_path(activity, @person.participant, @contact_link)
    - else
      = activity
    %br

- if no_consent 
  - if !@person.participant.consented? && !(@contact_link.event.to_s =~ /Pregnancy Screener/)
    %p
      = determine_participant_consent_path("Consent", @person.participant, @contact_link)
