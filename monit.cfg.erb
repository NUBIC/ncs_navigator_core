<% PWD = ENV["PWD"] %>
<% PID_FILE = File.join(PWD, 'tmp', 'pids', 'sidekiq.pid') %>

<% 
  env = %w(PATH GEM_HOME_GEM_PATH RAILS_ENV).reject{ |e| ENV[e].blank? }.map{ |e| "export #{e}=#{ENV[e]}"}
  cd = "cd #{PWD}"
  sidekiq = "bundle exec sidekiq -P #{PID_FILE}"
  command = [env, cd, sidekiq].flatten.join(' && ')
%>

check process sidekiq
  with pidfile <%= PID_FILE %>
  start program = "/bin/bash -c '<%= command %>'" with timeout 90 seconds
  stop program = "/bin/bash -c 'kill -s TERM `cat <%= PID_FILE %>`'" with timeout 90 seconds
  group ncs_navigator_core